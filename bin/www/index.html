<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
      }
      .bordered-container {
        display: flex;
        border: black solid 2px;
        padding: 5px;
        gap: 10px;
        background-color: white;
      }
      .bordered-container:hover {
        background-color: #eee;
      }
      .container {
        display: flex;
        padding: 5px;
        gap: 10px;
      }
      .title {
        display: grid;
        grid-template-columns: 35px 5px auto;
        grid-template-areas: 'label . text';
      }
      .title-label {
        grid-area: label;
        align-self: center;
      }
      .title-text {
        grid-area: text;
        align-self: center;
      }
      .detail {
        display: grid;
        grid-template-columns: 40px 10px auto;
        grid-template-areas: 'label . text';
        padding:5px"
      }
      .detail-label {
        grid-area: label;
        align-self: center;
        width: 40px;
        height: 40px;
        background-color: orange;
        align-items: center;
        justify-content: center
      }
      .detail-text {
        grid-area: text;
        align-self: center;
      }
      .editor-imagen {
        background-color: lightseagreen;
        width: 600px;
        height: 400px;
      }
      .button {
        border: #767676 solid 1px;
        border-radius: 3px;
        padding: 3px 7px;
        background-color: #efefef;
        font-family: sans-serif;
        font-size: small;
      }
      .button:hover {
        border: #4f4f4f solid 1px;
        background-color: #e5e5e5;
      }
      .close {
        border: #4f4f4f solid 2px;
        border-radius: 3px;
        background-color: #f55;
        color: white;
        font-weight: bold;
      }
      .close:hover {
        border: black solid 2px;
        background-color: #f22;
      }
    </style>
  </head>
  <body>
    <div id="app" class="container" style="flex-direction: column">
      <manual-section
        v-for="(section, index) in sectionList.items"
        :id="section.id"
        :key="section.id"
        :index="index"
        :items="section.items"
        @add-item="addItem"
        @delete-item="deleteItem"
        @update-item="updateItem"
      ></manual-section>
      <div class="container" style="justify-content: center">
        <button @click="addSection()">Add Section</button>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script>
      class ManualParagraph {
        constructor(id) {
          this.id = id;
          this.content = '';
          this.type = 'paragraph';
        }
        update(newContent) {
          this.content = newContent;
        }
      }

      class ManualImagePointer {
        constructor(id, data) {
          this.id = id;
          this.labelX = data.labelX;
          this.labelY = data.labelY;
          this.regionX = data.regionX;
          this.regionY = data.regionY;
          this.regionWidth = data.regionWidth;
          this.regionHeight = data.regionHeight;
          this.pinX = data.regionX + Math.floor(data.regionWidth / 2);
          this.pinY = data.regionY + Math.floor(data.regionHeight / 2);
          this.description = '';
          this.type = 'detail';
        }
        update(data) {
          if (data.property === 'label') {
            this.labelX = data.values[0];
            this.labelY = data.values[1];
          } else if (data.property === 'pin') {
            this.pinX = data.values[0];
            this.pinY = data.values[1];
          } else if (data.property === 'description') {
            this.description = data.values[0];
          }
        }
      }

      class ManualImage {
        constructor(id) {
          this.id = id;
          this.name = '';
          this.nextItem = 1;
          this.items = [];
          this.type = 'image';
        }
        addItem(data) {
          const pointer = new ManualImagePointer(
            `${this.id}.${this.nextItem}`,
            data
          );
          this.nextItem += 1;
          this.items.push(pointer);
          return pointer;
        }
        deleteItem(index) {
          this.items.splice(index, 1);
        }
        update(newName) {
          this.name = newName;
        }
      }

      class ManualSection {
        constructor(id) {
          this.id = id;
          this.title = '';
          this.nextItem = 1;
          this.items = [];
          this.type = 'section';
        }
        addItem(type) {
          let item;
          const itemId = `${this.id}.${this.nextItem}`;
          this.nextItem += 1;
          if (type === 'paragraph') {
            item = new ManualParagraph(itemId);
          } else if (type === 'image') {
            item = new ManualImage(itemId);
          } else {
            item = new ManualSection(itemId);
          }
          this.items.push(item);
          return item;
        }
        deleteItem(index) {
          this.items.splice(index, 1);
        }
        update(newTitle) {
          this.title = newTitle;
        }
      }

      class ManualSectionList {
        constructor() {
          this.nextItem = 1;
          this.items = [];
        }
        addItem() {
          const section = new ManualSection(`${this.nextItem}`);
          this.nextItem += 1;
          this.items.push(section);
          return section;
        }
        deleteItem(index) {
          this.items.splice(index, 1);
        }
      }

      Vue.component('manual-paragraph', {
        template: `
        <div
          class="bordered-container"
          style="flex-direction: column; border-color: red"
        >
          <div class="container" style="justify-content: flex-end">
            <button class="close" @click="deleteParagraph">X</button>
          </div>
          <textarea rows="5" @change="updateParagraph" v-model="content">
          </textarea>
        </div>
        `,
        props: {
          id: {type: String, required: true},
          index: {type: Number, required: true},
        },
        data() {
          return {content: ''};
        },
        methods: {
          deleteParagraph() {
            this.$emit('delete-item', this.id, this.index);
          },
          updateParagraph() {
            this.$emit('update-item', this.id, this.content);
          },
        },
      });

      Vue.component('manual-detail', {
        template: `
        <div
          class="bordered-container"
          style="flex-direction: column; border-color: orange"
        >
          <div class="container" style="justify-content: flex-end">
            <button class="close" @click="deleteDetail">X</button>
          </div>
          <div class="detail">
            <div class="detail-label container">
              {{index + 1}}
            </div>
            <textarea
              class="detail-text"
              rows="5"
              v-model="content"
              @change="updateDetail"
            >
            </textarea>
          </div>
        </div>
        `,
        props: {
          id: {type: String, required: true},
          index: {type: Number, required: true},
        },
        data() {
          return {
            content: '',
          };
        },
        methods: {
          deleteDetail() {
            this.$emit('delete-item', this.id, this.index);
          },
          updateDetail() {
            this.$emit('update-item', this.id, {
              property: 'description',
              values: [this.content],
            });
          },
        },
      });

      Vue.component('manual-selector', {
        template: `
          <div class="container" style="flex-direction: column">

            <div class="container" style="justify-content: center">
              <input
                :id="inputFileId"
                type="file"
                accept="image/*"
                ref="selector"
                style="display: none"
                @change="selectImage"
              >
              <label
                class="button"
                :for="inputFileId"
              >Select Image</label>
            </div>
          </div>
        `,
        props: {
          id: {type: String, required: true},
        },
        methods: {
          async selectImage() {
            const {files} = this.$refs.selector;
            const image = files.length ? files[0] : null;
            if (!image) {
              return;
            }
            const formData = new FormData();
            formData.append('image', image);
            try {
              const response = await axios.post('/images', formData, {
                headers: {
                  'Content-Type': 'multipart/form-data',
                },
              });
              this.$emit('update-item', this.id, response.data.name);
            } catch (error) {
              console.log(error);
            }
          },
        },
        computed: {
          inputFileId() {
            return `inputfile${this.id}`;
          },
        },
      });

      Vue.component('manual-viewer', {
        template: `
          <div
            class="container"
            style="flex-wrap: nowrap; white-space: nowrap; overflow-x: auto;"
          >
            <div style="display: flex; margin-left: auto; margin-right: auto">
              <img
                :src="imagePath"
                style="display: none"
                ref="img"
                @load="onLoadImg">
              <svg
                style="border: black solid 1px"
                :width="fullWidth"
                :height="fullHeight"
              >
                <image
                  :xlink:href="imagePath"
                  :x="borderLength"
                  :y="borderLength"
                  @mousedown="startRegionSelection"
                  @mousemove="updateSelectedRegion"
                  @mouseup="stopRegionSelection"
                />
                <line
                  v-for="item in items"
                  :x1="item.labelX + halfLength"
                  :y1="item.labelY + halfLength"
                  :x2="item.pinX"
                  :y2="item.pinY"
                  stroke="orange"
                  stroke-width="2"
                />
                <rect
                  v-for="item in items"
                  :x="item.labelX"
                  :y="item.labelY"
                  :width="labelLength"
                  :height="labelLength"
                  fill="orange"
                  @mousedown="startLabelDrag($event, item)"
                  @mousemove="dragLabel($event, item)"
                  @mouseup="stopLabelDrag"
                  @mouseleave="stopLabelDrag"
                />
                <text
                  v-for="(item, index) in items"
                  :x="item.labelX + halfLength"
                  :y="item.labelY  + halfLength"
                  dominant-baseline="central"
                  text-anchor="middle"
                  fill="white"
                  font-family="monospace"
                  font-size="24px"
                  @mousedown="startLabelDrag($event, item)"
                  @mousemove="dragLabel($event, item)"
                  @mouseup="stopLabelDrag"
                  @mouseleave="stopLabelDrag"
                >
                  {{index + 1}}
                </text>
                <rect
                  v-for="item in items"
                  :x="item.regionX"
                  :y="item.regionY"
                  :width="item.regionWidth"
                  :height="item.regionHeight"
                  stroke="orange"
                  fill-opacity="0"
                  @mousedown="startLabelDrag($event, item)"
                  @mousemove="dragLabel($event, item)"
                  @mouseup="stopLabelDrag"
                  @mouseleave="stopLabelDrag"
                />
                <rect
                  v-show="isSelectingRegion"
                  :x="regionX"
                  :y="regionY"
                  :width="regionWidth"
                  :height="regionHeight"
                  @mousemove="updateSelectedRegion"
                  @mouseup="stopRegionSelection"
                />
                
              </svg>
            </div>
          </div>
        `,
        props: {
          id: {type: String, required: true},
          name: {type: String, required: true},
          items: {type: Array, required: true},
        },
        data() {
          return {
            pointers: [{x: 0, y: 0}],
            labelLength: 30,
            imageMargin: 40,
            imageWidth: 0,
            imageHeight: 0,
            pointerActive: null,
            x: 0,
            y: 0,
            x2: 0,
            y2: 0,
            isSelectingRegion: false,
          };
        },
        methods: {
          onLoadImg() {
            const extra = 2 * this.borderLength;
            this.imageWidth = this.$refs.img.width;
            this.imageHeight = this.$refs.img.height;
          },
          startLabelDrag(event, pointer) {
            this.pointerActive = pointer;
            this.x = event.offsetX;
            this.y = event.offsetY;
          },
          stopLabelDrag() {
            this.pointerActive = null;
          },
          dragLabel(event, pointer) {
            if (!this.pointerActive) {
              return;
            }
            if (this.pointerActive !== pointer) {
              this.pointerActive = null;
            }
            let newX = pointer.labelX + event.offsetX - this.x;
            let newY = pointer.labelY + event.offsetY - this.y;
            this.x = event.offsetX;
            this.y = event.offsetY;
            if (newX < 0) {
              newX = 0;
            } else if (newX > this.maxX) {
              newX = this.maxX;
            }
            if (newY < 0) {
              newY = 0;
            } else if (newY > this.maxY) {
              newY = this.maxY;
            }
            const marginLeft = newX;
            const marginTop = newY;
            const marginRight = this.fullWidth - newX - this.labelLength;
            const marginBottom = this.fullHeight - newY - this.labelLength;
            const minMargin = Math.min(
              marginLeft,
              marginTop,
              marginRight,
              marginBottom
            );
            if (marginLeft === minMargin) {
              newX = 0;
            } else if (marginTop === minMargin) {
              newY = 0;
            } else if (marginRight === minMargin) {
              newX = this.maxX;
            } else {
              newY = this.maxY;
            }
            this.$emit('update-item', pointer.id, {
              property: 'label',
              values: [newX, newY],
            });
          },
          startRegionSelection(event) {
            this.isSelectingRegion = true;
            this.x = event.offsetX;
            this.y = event.offsetY;
          },
          updateSelectedRegion(event) {
            this.x2 = event.offsetX;
            this.y2 = event.offsetY;
          },
          stopRegionSelection() {
            if (this.isSelectingRegion) {
              const marginLeft = this.regionX;
              const marginTop = this.regionY;
              const marginRight =
                this.fullWidth - this.regionX - this.regionWidth;
              const marginBottom =
                this.fullHeight - this.regionY - this.regionHeight;
              const minMargin = Math.min(
                marginLeft,
                marginTop,
                marginRight,
                marginBottom
              );
              let labelX;
              let labelY;
              if (marginLeft === minMargin) {
                labelX = 0;
                labelY =
                  this.regionY +
                  Math.floor((this.regionHeight - this.labelLength) / 2);
              } else if (marginTop === minMargin) {
                labelX =
                  this.regionX +
                  Math.floor((this.regionWidth - this.labelLength) / 2);
                labelY = 0;
              } else if (marginRight === minMargin) {
                labelX = this.maxX;
                labelY =
                  this.regionY +
                  Math.floor((this.regionHeight - this.labelLength) / 2);
              } else {
                labelX =
                  this.regionX +
                  Math.floor((this.regionWidth - this.labelLength) / 2);
                labelY = this.maxY;
              }
              this.$emit('add-item', this.id, {
                labelX,
                labelY,
                regionX: this.regionX,
                regionY: this.regionY,
                regionWidth: this.regionWidth,
                regionHeight: this.regionHeight,
              });
              this.isSelectingRegion = false;
            }
          },
        },
        computed: {
          imagePath() {
            return `./images/${this.name}`;
          },
          borderLength() {
            return this.labelLength + this.imageMargin;
          },
          fullWidth() {
            return this.imageWidth + 2 * this.borderLength;
          },
          fullHeight() {
            return this.imageHeight + 2 * this.borderLength;
          },
          maxX() {
            return this.fullWidth - this.labelLength;
          },
          maxY() {
            return this.fullHeight - this.labelLength;
          },
          regionX() {
            return Math.min(this.x, this.x2);
          },
          regionY() {
            return Math.min(this.y, this.y2);
          },
          regionWidth() {
            return Math.abs(this.x - this.x2);
          },
          regionHeight() {
            return Math.abs(this.y - this.y2);
          },
          halfLength() {
            return Math.floor(this.labelLength / 2);
          },
        },
      });

      Vue.component('manual-image', {
        template: `
          <div
            class="bordered-container"
            style="flex-direction: column; border-color: blue"
          >
            <div class="container" style="justify-content: flex-end">
              <button class="close" @click="deleteItem(id, index)">X</button>
            </div>
            <manual-selector
              v-if="!isSelected"
              :id="id"
              @update-item="updateItem"
            >
            </manual-selector>
            <manual-viewer
              v-else="isSelected"
              :id="id"
              :name="name"
              :items="items"
              @add-item="addItem"
              @update-item="updateItem"
            >
            </manual-viewer>
            <manual-detail
              v-for="(item, index) in items"
              :id="item.id"
              :key="item.id"
              :index="index"
              @delete-item="deleteItem"
              @update-item="updateItem"
            >
            </manual-detail>
          </div>
        `,
        props: {
          id: {type: String, required: true},
          name: {type: String, required: true},
          items: {type: Array, required: true},
          index: {type: Number, required: true},
        },
        data() {
          return {};
        },
        methods: {
          addItem(parentId, data) {
            this.$emit('add-item', parentId, data);
          },
          deleteItem(id, index) {
            this.$emit('delete-item', id, index);
          },
          updateItem(id, data) {
            this.$emit('update-item', id, data);
          },
        },
        computed: {
          isSelected() {
            return this.name !== '';
          },
        },
      });

      Vue.component('manual-section', {
        template: `
          <div class="bordered-container" style="flex-direction: column">
            <div class="container" style="justify-content: flex-end">
              <button class="close" @click="deleteItem(id, index)">X</button>
            </div>
            <div class="title">
              <label class="title-label" :for="titleId">Title:</label>
              <input
                :id="titleId"
                class="title-text"
                type="text"
                v-model="title"
                @change="updateItem(id, title)">
            </div>
            <template v-for="(item, index) in items">
              <manual-section
                v-if = "item.type === 'section'"
                :id="item.id"
                :key="item.id"
                :index="index"
                :items="item.items"
                @add-item="addItem"
                @delete-item="deleteItem"
                @update-item="updateItem"
              ></manual-section>
              <manual-paragraph
                v-else-if = "item.type === 'paragraph'"
                :id="item.id"
                :key="item.id"
                :index="index"
                @delete-item="deleteItem"
                @update-item="updateItem"
              ></manual-paragraph>
              <manual-image
                v-else-if = "item.type === 'image'"
                :id="item.id"
                :key="item.id"
                :index="index"
                :items="item.items"
                :name="item.name"
                @add-item="addItem"
                @delete-item="deleteItem"
                @update-item="updateItem"
              ></manual-image>
            </template>
            <div class="container" style="justify-content: center">
              <button @click="addItem(id, 'paragraph')">
                Add Paragraph
              </button>
              <button @click="addItem(id, 'image')">
                Add Image
              </button>
              <button @click="addItem(id, 'section')">
                Add Subsection
              </button>
            </div>
          </div>
        `,
        props: {
          id: {type: String, required: true},
          items: {type: Array, required: true},
          index: {type: Number, required: true},
        },
        data() {
          return {title: ''};
        },
        methods: {
          addItem(parentId, data) {
            this.$emit('add-item', parentId, data);
          },
          deleteItem(id, index) {
            this.$emit('delete-item', id, index);
          },
          updateItem(id, data) {
            this.$emit('update-item', id, data);
          },
        },
        computed: {
          titleId() {
            return 'title' + this.id;
          },
        },
      });

      const app = new Vue({
        el: '#app',
        data: {
          sectionList: new ManualSectionList(),
          allItems: {},
        },
        methods: {
          addItem(parentId, data) {
            const parent = this.allItems[parentId];
            const newItem = parent.addItem(data);
            this.allItems[newItem.id] = newItem;
          },
          addSection() {
            const newSection = this.sectionList.addItem();
            this.allItems[newSection.id] = newSection;
          },
          deleteChilds(item) {
            if (!item.items || item.items.length === 0) {
              return;
            }
            const queue = [...item.items];
            let i;
            while (queue.length > 0) {
              i = queue.shift();
              delete this.allItems[i.id];
              if (i.items && i.items.length > 0) {
                queue.push(...i.items);
              }
            }
          },
          deleteItem(id, index) {
            const splittedId = id.split('.');
            let parent;
            if (splittedId.length === 1) {
              parent = this.sectionList;
            } else {
              splittedId.pop();
              parent = this.allItems[splittedId.join('.')];
            }
            const item = parent.items[index];
            this.deleteChilds(item);
            parent.deleteItem(index);
            delete this.allItems[id];
          },
          updateItem(id, data) {
            const item = this.allItems[id];
            item.update(data);
          },
        },
      });
    </script>
  </body>
</html>
